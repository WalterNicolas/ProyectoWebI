<!DOCTYPE HTML>
<html lang="es" xmlns:th="http://www.thymeleaf.org"  xmlns:sec="http://www.thymeleaf.org/extras/spring-security" >
<head th:replace="templates/head :: head">
</head>
<body>
<div th:replace="templates/header :: header">
</div>
<div class="row p-5 text-light justify-content-center">
    <div class="col-md-5 m-2 rounded-xl  bg-white bg-opacity-50">
    <h2 class="">Mis rutinas</h2>
    <div class="summary-card">
        <h3>Resumen de la semana</h3>
        <p class="texto2">4/5 Rutinas cumplidas</p>
        <p class="texto2">-10% Peso</p>
        <p class="texto2">IMC es 21.5</p>
        <p class="texto2">1 Rutinas por hacer</p>
    </div>
    </div>
        <div class="col-md-5 rounded-xl bg-white  bg-opacity-50">
                <div class="col-user ">
                    <img class="profile-img" th:src="@{/img/user-icon.png}" alt="">
                    <p class="user-name">Nombre-Usuario</p>
                </div>
                <div class="col-list ">
                    <p class="to-do-list">Todos mis ejercicios</p>
                    <ul>
                        <!-- Recorrer la lista de rutinas y mostrar cada rutina -->
                        <li tr th:each="rutina : ${rutinaSemanal.getRutinaDiaria()}">
                            <tr th:each="ejercicio : ${rutina.getEjercicios()}">
                                <span th:text="${ejercicio.getDiaSemana()}"></span>
                                <span th:text="${ejercicio.getDescripcion()}"></span>
                                <span th:if="${ejercicio.realizado}"> - Realizado</span>
                                <span th:unless="${ejercicio.realizado}"> - Por Hacer</span>
                        </li>
                    </ul>
                </div>
            </div>
</div>

<h3>Actualizar Datos</h3>
<button class="btn" id="btnActualizar">Actualizar</button>
<!-- Formulario pop-up para editar estado -->
<div id="popup" class="popup-form">
    <h3>Editar Estado</h3>
    <form id="formulario-ejercicio">
        <input type="hidden" id="ejercicio-id" name="id">
        <label><input type="checkbox" id="estado-checkbox" name="estado"> Realizado</label><br>
        <button type="submit" class="btn btn-primary">Guardar</button>
        <button type="button" class="btn btn-secondary cancelar">Cancelar</button>
    </form>
</div>

<!-- JavaScript y jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $(document).ready(function() {
        // Mostrar formulario pop-up al hacer clic en un ejercicio
        $('#ejercicios-lista').on('click', 'li', function() {
            var id = $(this).data('id');
            var nombre = $(this).find('.nombre').text();
            var estado = $(this).data('estado');

            // Llenar el formulario con los datos del ejercicio seleccionado
            $('#ejercicio-id').val(id);
            $('#estado-checkbox').prop('checked', estado === 'realizado');

            // Mostrar el formulario pop-up
            $('#popup-formulario').show();
        });

        // Cancelar la edición y cerrar el formulario pop-up
        $('.cancelar').click(function() {
            $('#popup-formulario').hide();
        });

        // Enviar el formulario mediante AJAX
        $('#formulario-ejercicio').submit(function(event) {
            event.preventDefault();

            var id = $('#ejercicio-id').val();
            var estado = $('#estado-checkbox').is(':checked') ? 'realizado' : 'por-hacer';

            // Mostrar confirmación antes de enviar los datos
            var confirmacion = confirm('¿Estás seguro de cambiar el estado del ejercicio?');
            if (!confirmacion) {
                return;
            }

            // Enviar los datos mediante AJAX
            $.ajax({
                url: '/actualizarRutina',
                method: 'POST',
                data: {
                    id: id,
                    estado: estado
                },
                success: function(response) {
                    // Actualizar visualización del ejercicio en la lista
                    var $ejercicio = $('#ejercicios-lista').find('[data-id="' + id + '"]');
                    $ejercicio.attr('data-estado', estado);
                    $ejercicio.find('.estado').prop('checked', estado === 'realizado');

                    // Cerrar formulario pop-up
                    $('#popup-formulario').hide();
                },
                error: function(xhr, status, error) {
                    alert('Error al actualizar el estado del ejercicio. Por favor, inténtalo de nuevo.');
                }
            });
        });
    });
</script>
<footer th:replace="templates/footer:: footer">
</footer>
</body>
</html>
